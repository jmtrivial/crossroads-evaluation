<!DOCTYPE html>
<html lang="fr-FR" class="no-js">
    <head>
        <meta charset="UTF-8">
        <title>Crossroad quality evaluation</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
            
        
        <script>
            function shuffle(array) {
                let currentIndex = array.length,  randomIndex;

                // While there remain elements to shuffle...
                while (currentIndex != 0) {

                    // Pick a remaining element...
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;

                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
                }

                return array;
            }
            
            function build_question_interface() {
                // TODO
            }
            
            function update_question_interface() {
                $("#crossroad_title").text("Crossroad #" + window.crossroads_index[window.current_id]);
                // TODO
            }
            
            function set_current_crossroad_evaluation() {
                window.crossroads[window.crossroads_index[window.current_id]]["evaluation"] = {};
                // TODO
            }
            
            
            function compute_nb_processed() {
                nb = 0;
                return window.crossroads.filter(function(item){
                    return item.hasOwnProperty("evaluation");
                }).length;
            }
            
            
            function find_next_open_question() {
                while(window.crossroads[window.crossroads_index[window.current_id]].hasOwnProperty("evaluation")) {
                    window.current_id += 1;
                }
            }
            
            function set_next_question() {
                find_next_open_question();
                
                $("#nb_processed").text(window.nb_processed);
                if (window.nb_processed != 0) {
                    $("#download").prop("disabled", false);
                }
                //$("#next").prop("disabled", true);
                
                update_question_interface();
                
            }
            
            // init interface
            function start_questions() {
                $("#main-container>div").css("display", "none");
                $("#question").css("display", "block");
                
                window.current_id = 0;
                
                
                set_next_question();
            }

            function ask_settings() {
                $("#main-container>div").css("display", "none");
                $("#settings").css("display", "block");
            }
            
            function build_index() {
                window.crossroads_index = Array.from(Array(window.crossroads.length).keys());
            }

            function the_end() {
                $("#main-container>div").css("display", "none");
                $("#the_end").css("display", "block");
            }
        
            $(document).ready(function () {
                $("#next").click(function(evt) {
                    set_current_crossroad_evaluation();
                    window.nb_processed += 1;
                    if (window.crossroads.length == window.nb_processed) {
                        the_end();
                    }
                    else {
                        set_next_question();
                    }
                });
                
                $("#download").click(function(evt) {
                    // TODO
                });
                
                $("#regular").click(function(evt) {
                    build_index();
                    start_questions();
                });

                $("#shuffle").click(function(evt) {
                    build_index();
                    shuffle(window.crossroads_index);
                    start_questions();
                });

                $("#inputFile").on("change", function handleFileSelect(evt) {
                    if (evt == null || evt.target == null || evt.target.files == null || evt.target.files.length == 0) {
                        console.log("no input file");
                        return;
                    }

                    var file = evt.target.files[0];

                    if (file.type != "application/json") {
                        console.log("bad format");
                        return;
                    }
                    
                    const fr = new FileReader();

                    fr.addEventListener("load", e => {
                        $("#main-container>div").css("display", "none");
                        $("#chargement").css("display", "block");
                        
                        // load data
                        window.crossroads = JSON.parse(fr.result);
                        
                        // set numbers
                        $("#nb_crossroads").text(window.crossroads.length);
                        $("#settings_nb_crossroads").text(window.crossroads.length);
                        window.nb_processed = compute_nb_processed();
                        $("#nb_processed").text(window.nb_processed);

                        ask_settings();
                    });

                    fr.readAsText(file);
                });
                
                build_question_interface();

            });
            
        </script>
        <style>
            #question, #chargement, #settings, #the_end { display: none; }
            
        </style>

    </head>
	<body>
        <div class="container-xl" id="main-container">
            
            <h1>Crossroad quality evaluation</h1>
             <p class="lead">By answering the following questions, you will evaluate the quality of a junction detection and segmentation algorithm in <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, and participate in the <a href="https://activmap.limos.fr/">ANR ACTIVmap project</a>.
            </p>
            <div id="start">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">
                        <p>Select a <code>json</code> file</p>
                        <div class="btn btn-primary btn-block" style="width: 100%">
                                        <label style="padding: 0" tkey="chooseFile">Load crossroads</label>
                                            <input type="file" id="inputFile" name="files[]" accept="application/json" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; opacity: 0">
                        </div>
                 </div>
            </div>
            <div id="chargement">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">Chargement des donn√©es...</div>
            </div>
            <div id="settings">
                <div class="position-absolute top-50 start-50 translate-middle fs-1 col-6">
                    <p>Do you want to shuffle the <span id="settings_nb_crossroads"></span> crossroads, or evaluate them in regular order?</p>
                    <div class="container mt-3">
                        <div class="row">
                        <div class="col-6">
                            <button id="regular" class="btn btn-primary btn-block form-control" type="button">Regular</button>
                        </div>
                        <div  class="col-6">
                            <button id="shuffle" class="btn btn-primary btn-block form-control" type="button">Shuffle</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="question">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title" id="crossroad_title"></h2>
                        <div class="container">
                            <div class="row">
                                <div class="col-6" id="questions">
                                
                                </div>
                                <div class="col-6" id="map">
                                
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="container mt-3">
                    <div class="row">
                    <div class="col-6">
                        <button id="download" class="btn btn-secondary" style="width: 100%" type="button" disabled>Download evaluations (<span id="nb_processed">0</span> / <span id="nb_crossroads">-</span>)</button>
                    </div>
                    <div  class="col-6">
                        <button id="next" class="btn btn-primary" style="width: 100%" type="button">Next crossroad</button>
                    </div>
                    </div>
                </div>
            </div>
            <div id="the_end">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">
                        <p>Download <code>json</code> file</p>
                        <button id="download_end" class="btn btn-primary" type="button" style="width: 100%">Get evaluations</button>
                 </div>
            </div>
        </div>
    </body>
</html>
